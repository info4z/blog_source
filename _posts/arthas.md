---
title: Arthas
excerpt: java 诊断工具, 用于生产环境调错
date: 2023-01-13
categories: 服务器
tags: 诊断
---







## 一 : 概述

### (一) 概述

`Arthas` 是一款线上监控诊断产品，通过全局视角实时查看应用 load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，包括查看方法调用的出入参、异常，监测方法执行耗时，类加载信息等，大大提升线上问题排查效率。

### (二) 背景

通常，本地开发环境无法访问生产环境。如果在生产环境中遇到问题，则无法使用 `IDE` 远程调试。更糟糕的是，在生产环境中调试是不可接受的，因为它会暂停所有线程，导致服务暂停。

开发人员可以尝试在测试环境或者预发环境中复现生产环境中的问题。但是，某些问题无法在不同的环境中轻松复现，甚至在重新启动后就消失了。

如果您正在考虑在代码中添加一些日志以帮助解决问题，您将必须经历以下阶段：测试、预发，然后生产。这种方法效率低下，更糟糕的是，该问题可能无法解决，因为一旦 `JVM` 重新启动，它可能无法复现，如上文所述。

`Arthas` 旨在解决这些问题。开发人员可以在线解决生产问题。无需 `JVM` 重启，无需代码更改。 `Arthas` 作为观察者永远不会暂停正在运行的线程。

### (三) 用途

`Arthas` 是 Alibaba 开源的 Java 诊断工具。当你遇到以下类似问题而束手无策时，`Arthas`可以帮助你解决：

1. 这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？
2. 我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？
3. 遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？
4. 线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！
5. 是否有一个全局视角来查看系统的运行状况？
6. 有什么办法可以监控到 JVM 的实时运行状态？
7. 怎么快速定位应用的热点，生成火焰图？
8. 怎样直接从 JVM 内查找某个类的实例？



## 二 : 快速入门

### (一) 下载启动

* 下载 jar 包

  ```sh
  $ curl -O https://arthas.aliyun.com/arthas-boot.jar
  ```

* 启动

  ```shell
  # 执行该程序的用户需要和目标进程具有相同的权限
  $ java -jar arthas-boot.jar
  # 可以执行如下命令来查看帮助
  $ java -jar arthas-boot.jar -h
  ```

* 选择应用 : 数据对应程序的编号, 然后回车即可

* 未进入指定程序退出 : `ctrl + c`
* 进入指定程序后退出 : `ctrl + d`

### (二) 常用操作

* dashboard : 选择指定程序后, 输入 `dashboard` 后回车, 即可进入看板, 按 `ctrl+c `可以中断执行

  ```sh
  $ dashboard
  ```

  * 主要涉及到当前执行的线程, 内存情况和运行环境

* thread : 查看当前线程, 命令 : `thread ID`

  ```sh
  $ thread 1 | grep 'main('
      at demo.MathGame.main(MathGame.java:17)
  ```

* jad : 反编译工具, 通过 jad 来反编译 Main Class

  ```sh
  $ jad demo.MathGame
  ```

* watch : 查看具体函数的参数和返回值

  ```sh
  $ watch demo.MathGame primeFactors returnObj
  ```

### (三) 退出

* 如果只是退出当前的连接，可以用`quit`或者`exit`命令。Attach 到目标进程上的 arthas 还会继续运行，端口会保持开放，下次连接时可以直接连接上。
* 如果想完全退出 arthas，可以执行`stop`命令。