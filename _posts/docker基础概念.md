---
title: docker基础概念
excerpt: 通过基础概念加深对其架构的理解
date: 2021-01-08
categories: 容器化技术
tags: [docker, docker入门]
---



## 一 : docker 是什么

docker 最初是 dotCloud 公司创始人 Solomon Hykes 在法国期间发起的一个公司内部项目, 它是基于 dotCloud 公司多年云服务技术的一次革新, 并于 2013 年 3 月以 Apache 2.0 授权协议开源, 主要项目代码在 GitHub 上进行维护。

docker 项目后来还加入了 Linux 基金会, 并成立推动 **OCI** (开放容器联盟)。

docker 使用 Google 公司退出的 **Go 语言** 进行开发实现, 基于 Linux 内核的 cgroup, namespace, 以及 AUFS 类的 Union FS 等技术, 对进程进行封装隔离, 属于操作系统层面的虚拟化技术。

由于隔离的进程独立于宿主和其他的隔离的进程, 因此也称其为**容器**。

docker 在容器的基础上, 进行了进一步的封装, 从文件系统, 网络互联到进程隔离等等, 极大的简化了容器的创建和维护; 使得 **docker 技术比虚拟机技术更为轻便, 快捷**。

| 传统虚拟机                                                   | docker                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 传统虚拟机技术是虚拟出一套硬件后, 在其上运行一个完整操作系统, 在该系统上再运行所需应用进程 | 容器内的应用进程直接运行于宿主的内核, 容器内没有自己的内核, 而且也没有进行硬件虚拟; 因此容器要比虚拟机更为轻便 |



## 二 : 为什么要使用 docker

docker 的优势有 : 更高效的利用系统资源, 更快速的启动时间, 一致的运行环境, 持续交付的部署, 更轻松的迁移, 更轻松的维护和扩展。

对比传统虚拟机

| 特性       | 容器               | 虚拟机     |
| ---------- | ------------------ | ---------- |
| 启动       | 秒级               | 分钟级     |
| 硬盘使用   | 一般为MB           | 一般为GB   |
| 性能       | 接近原生           | 较弱       |
| 系统支持量 | 单机支持上千个容器 | 一般几十个 |



## 三 : docker 架构

docker 使用客户端-服务器(C/S)架构模式, 使用远程API来管理和创建 docker 容器。

![docker 架构图](https://docs.docker.com/engine/images/architecture.svg)



## 四 : docker 基本概念

docker 包括三个基本概念 : 镜像(image), 容器(container), 仓库(repository); 理解了这三个概念, 就理解了 docker 的整个生命周期。

### (一) docker 镜像

我们都知道, 操作系统分为内核和用户空间, 对于 linux 而言, 内核启动后, 会挂载 root 文件系统为其提供用户空间支持; 而 docker 镜像 (image), 就相当于是一个 root 文件系统, 比如官方镜像 centos:7.6 就包含了完整的一套 centos 7.6 最小系统的 root 文件系统。

docker 镜像是一个**特殊的文件系统**, 除了提供容器运行时所需的程序, 库, 资源, 配置等文件外, 还包含了一些为运行时准备的一些配置参数(如匿名卷, 环境变量, 用户等); 镜像不包含任何动态数据, 其内容在构建之后也不会被改变。

因为镜像包含操作系统完整的 root 文件系统, 其体积往往是庞大的, 因此 docker 设计时将其设计为**分层存储的架构**; 镜像只是一个虚拟的概念, 其实际体现并非由一个文件组成, 而是由一组文件系统组成, 或者说, **由多重文件系统联合组成**。

镜像构建时, 会一层层构建, 前一层是后一层的基础; 每一次构建完就不会再发生改变, 后一层上的任何改变只发生在自己这一层; 在构建镜像的时候, 需要额外小心, 每一层尽量只包含该层需要添加的东西, 任何额外的东西应该在该层构建结束前清理掉

**分层存储的特征还使得镜像的复用, 定制变的更为容易**; 甚至可以用之前构建好的镜像作为基础层, 然后进一步添加新的层, 以定制自己所需的内容, 构建新的镜像

### (二) docker 容器

镜像 (image) 和 容器 (container) 的关系, 就像 java 中的类和实例一样, **镜像是静态的定义, 容器是镜像运行时的实体**; 容器可以被创建, 启动, 停止, 删除, 暂停等

前面说过镜像使用的时**分层存储**, 容器也是如此; 每一个容器运行时, 是以镜像为基础层, 在其上创建一个当前容器的存储层, 我们可以称这个为容器运行时读写而准备的存储层为**容器存储层**

<u>容器存储层的生成周期和容器一样, 容器消亡时, 容器存储层也随之消亡;</u> 因此, 任何保存于容器存储层的信息都会随容器删除而丢失

按照 docker 最佳实践的要求, <u>容器不应该向其存储层内写入任何数据, 容器存储层要保持无状态化;</u> **所有的文件写入操作, 都应该使用 Volume 数据卷或者绑定宿主目录**, 在这些位置的读写会跳过容器存储层, 直接对宿主(或网络存储)发生读写, 其性能和稳定性更高

<u>数据卷(Volume)的生存周期独立于容器, 容器消亡, 数据卷不会消亡;</u> 因此, 使用数据卷后, 容器删除或者重新运行之后, 数据却不会丢失

### (三) docker 仓库

镜像构建完成后, 可以很容易的在当前宿主机上运行, 但是, 如果需要在其他服务器上使用这个镜像, 我们就需要一个集中的存储, 分发镜像的服务, docker registry 就是这样的服务

一个 docker registry 中可以包含多个仓库(repository); 每个仓库可以包含多个标签(tag); 每个标签对应一个镜像

通常, 一个仓库会包含同一个软件不同版本的镜像, 而**标签就常用于对应软件的各个版本**; 我们可以通过 `<仓库名>:<标签>` 的格式来指定具体是这个软件哪个版本的镜像; 如果不给出标签, 将以 latest 作为默认标签; 以 centos 镜像为例, centos 是仓库的名字, 其内包含不同的版本标签, 如: 6.9, 7.5; 我们可以通过 `centos:6.9`, 或者 `centos:7.5` 来具体指定所需哪个版本的镜像; 如果忽略了标签, 比如 centos, 那将是为 `centos:latest`

**仓库名经常以两段式路径形式出现, 比如 study/nginx**, 前者往往意味着 docker registry 多用户环境下的用户名, 后者则往往是对应的软件名; 但这并非绝对, 取决于所使用的具体 docker registry 的软件或服务

**1: 公开仓库**

常用的 registry 是官方的 docker hub, 这也是默认的 registry; 除此之外, 还有 CoreOS 的 Quay.io,  CoreOS 相关的镜像存储在这里; Google 的 Google Container Registry, Kubernetes 的镜像使用的就是这个服务

国内的一些云服务商提供了针对 docker hub 的镜像服务, 这些镜像服务被称为加速器; 常见的有**阿里云加速器**, **DaoCloud加速器**等; 使用加速器会直接从国内的地址下载 docker hub 的镜像, 比直接从 Docker Hub 下载速度会提高很多

国内也有一些云服务商提供类似于 docker hub 的公开服务; 比如**网易云镜像服务**, **DaoCloud镜像市场**, **阿里云镜像库**等

**2: 私有 docker registry**

除了使用公开服务外, 用户还可以在本地搭建私有 docker registry; docker 官方提供了 docker registry 镜像, 可以直接使用作为私有 registry 服务

开源的 docker registry 镜像只提供了 docker registry API 的服务端实现, 足以支持 docker 命令, 不影响使用; 但不包含图形界面, 以及镜像维护, 用户管理, 访问控制等高级功能; 在官方的商业化版本 docker trusted registry 中, 提供了这些高级功能

除了官方的 docker registry 外, 还有第三方软件实现了 docker registry API, 甚至提供了用户界面以及一些高级功能; 比如 VMWare Harbor 和 Sonatype Nexus